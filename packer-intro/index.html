<!DOCTYPE html>
<html lang="en"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-e2182856f2c32102dd26b05a5ef16cb5.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.30">

  <meta name="author" content="Daniel Matthews">
  <meta name="dcterms.date" content="2025-05-08">
  <title>Packer Intro</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #e1e4e8; background-color: #24292e; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #e1e4e8; } /* Normal */
    code span.al { color: #ff5555; font-weight: bold; } /* Alert */
    code span.an { color: #6a737d; } /* Annotation */
    code span.at { color: #f97583; } /* Attribute */
    code span.bn { color: #79b8ff; } /* BaseN */
    code span.bu { color: #f97583; } /* BuiltIn */
    code span.cf { color: #f97583; } /* ControlFlow */
    code span.ch { color: #9ecbff; } /* Char */
    code span.cn { color: #79b8ff; } /* Constant */
    code span.co { color: #6a737d; } /* Comment */
    code span.cv { color: #6a737d; } /* CommentVar */
    code span.do { color: #6a737d; } /* Documentation */
    code span.dt { color: #f97583; } /* DataType */
    code span.dv { color: #79b8ff; } /* DecVal */
    code span.er { color: #ff5555; text-decoration: underline; } /* Error */
    code span.ex { color: #f97583; font-weight: bold; } /* Extension */
    code span.fl { color: #79b8ff; } /* Float */
    code span.fu { color: #b392f0; } /* Function */
    code span.im { color: #9ecbff; } /* Import */
    code span.in { color: #6a737d; } /* Information */
    code span.kw { color: #f97583; } /* Keyword */
    code span.op { color: #e1e4e8; } /* Operator */
    code span.ot { color: #b392f0; } /* Other */
    code span.pp { color: #f97583; } /* Preprocessor */
    code span.re { color: #6a737d; } /* RegionMarker */
    code span.sc { color: #79b8ff; } /* SpecialChar */
    code span.ss { color: #9ecbff; } /* SpecialString */
    code span.st { color: #9ecbff; } /* String */
    code span.va { color: #ffab70; } /* Variable */
    code span.vs { color: #9ecbff; } /* VerbatimString */
    code span.wa { color: #ff5555; } /* Warning */
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-1e628d9b9c2a788768ba05abcbced60e.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-pointer/pointer.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-dark">
  <div class="reveal">
    <div class="slides">

<section class="quarto-title-block center">
  <h1 class="title">Packer Intro</h1>
  <p class="subtitle"><a href="https://www.ucl.ac.uk/advanced-research-computing/collaborations-consultancy/devops-collaborations">ARC DevOps Hour</a></p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Daniel Matthews 
</div>
</div>
</div>

  <p class="date">2025-05-08</p>
</section>
<section class="slide level2">
<h2>Who am I?</h2>
<ul>
<li>Co-lead of Medical Imaging Research Software Group (ARC Collaborations sub-group)</li>
<li>50% with Environments product over the last two years</li>
</ul>
</section>
<section class="slide level2">
<h2>What is Packer?</h2>
<ul>
<li class="fragment">Packer is a Hashicorp tool that lets you create identical machine images for multiple platforms from a single source template.</li>
<li class="fragment">A machine image is a single static unit that contains a pre-configured operating system and installed software.</li>
<li class="fragment">Can replace complex CI/CD pipelines.</li>
</ul>
<aside class="notes">
<p>Achieve the same configuration for multiple OS builds</p>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section class="slide level2">


<img data-src="./assets/packer.drawio.png" class="r-stretch quarto-figure-center"><p class="caption">Packer workflow</p><aside class="notes">
<ul>
<li>Remember to press “Q” for pointer</li>
<li>Keep templates in version control</li>
<li>Template defines a build which can use one or more plugins</li>
<li>Builders create machines from (for example) and turns them into images:
<ul>
<li>container images</li>
<li>vagrant boxes</li>
<li>iso files</li>
<li>qcow2 files</li>
</ul></li>
<li>Provisioners can customise the machine these can be:
<ul>
<li>Ansible playbooks</li>
<li>Scripts</li>
<li>Any other configuration tool</li>
</ul></li>
<li>The artifacts produced by the build are machine images
<ul>
<li>container images</li>
<li>qcow2 files</li>
<li>vagrant boxes</li>
</ul></li>
<li>Post processors can be employed to push the artifacts to a registry or create infrastructure (e.g.&nbsp;using Terraform)</li>
</ul>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section class="slide level2">
<h2>Templates</h2>
<ul>
<li>Like Terraform Packer templates are written in Hashicorp Configuration Language (HCL)</li>
</ul>
<div class="sourceCode" id="cb1" data-code-line-numbers="1-4|7-11"><pre class="sourceCode numberSource packer number-lines code-with-copy"><code class="sourceCode packer"><span id="cb1-1"><a></a><span class="op">&lt;</span>BLOCK TYPE<span class="op">&gt;</span> <span class="st">"&lt;BLOCK LABEL&gt;"</span> <span class="st">"&lt;BLOCK LABEL&gt;"</span> {</span>
<span id="cb1-2"><a></a>  <span class="co"># Block body</span></span>
<span id="cb1-3"><a></a>  <span class="op">&lt;</span>IDENTIFIER<span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span>EXPRESSION<span class="op">&gt;</span> <span class="co"># Argument</span></span>
<span id="cb1-4"><a></a>}</span>
<span id="cb1-5"><a></a></span>
<span id="cb1-6"><a></a><span class="co"># Source block from `amazon-instance` builder in Amazon plugin</span></span>
<span id="cb1-7"><a></a><span class="kw">source</span> <span class="st">"amazon-instance"</span> <span class="st">"basic-example"</span> {</span>
<span id="cb1-8"><a></a>  region        <span class="op">=</span> <span class="st">"eu-west-2"</span></span>
<span id="cb1-9"><a></a>  source_ami    <span class="op">=</span> <span class="st">"ami-d9d6a6b0"</span></span>
<span id="cb1-10"><a></a>  instance_type <span class="op">=</span> <span class="st">"m1.small"</span></span>
<span id="cb1-11"><a></a>  ssh_username  <span class="op">=</span> <span class="st">"ubuntu"</span></span>
<span id="cb1-12"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li class="fragment">Can also be written in JSON (was used prior to HCL) but is not recommended.</li>
</ul>
</section>
<section class="slide level2">
<h2>Blocks</h2>
<h4>packer.pkr.hcl</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource packer number-lines code-with-copy"><code class="sourceCode packer"><span id="cb2-1"><a></a><span class="kw">packer</span> {</span>
<span id="cb2-2"><a></a>  <span class="kw">required_plugins</span> {</span>
<span id="cb2-3"><a></a>    ansible <span class="op">=</span> {</span>
<span id="cb2-4"><a></a>      <span class="kw">version</span> <span class="op">=</span> <span class="st">"&gt;= 1.1.2"</span></span>
<span id="cb2-5"><a></a>      <span class="kw">source</span>  <span class="op">=</span> <span class="st">"github.com/hashicorp/ansible"</span></span>
<span id="cb2-6"><a></a>    }</span>
<span id="cb2-7"><a></a>  }</span>
<span id="cb2-8"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">
<h2>Blocks</h2>
<h4>variables.pkr.hcl</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource packer number-lines code-with-copy"><code class="sourceCode packer"><span id="cb3-1"><a></a><span class="kw">variable</span> <span class="st">"foo"</span> {</span>
<span id="cb3-2"><a></a>  type        <span class="op">=</span> <span class="dt">string</span></span>
<span id="cb3-3"><a></a>  default     <span class="op">=</span> <span class="st">"the default value of the `foo` variable"</span></span>
<span id="cb3-4"><a></a>  description <span class="op">=</span> <span class="st">"description of the `foo` variable"</span></span>
<span id="cb3-5"><a></a>  sensitive   <span class="op">=</span> <span class="va">false</span></span>
<span id="cb3-6"><a></a>  <span class="co"># When a variable is sensitive all string-values from that variable</span></span>
<span id="cb3-7"><a></a>  <span class="co"># will be obfuscated from Packer's output.</span></span>
<span id="cb3-8"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li class="fragment">Can be set at the command line, from a file or environment variables (when prefixed with <code>PKR_VAR_</code>)</li>
</ul>
</section>
<section class="slide level2">
<h2>Blocks</h2>
<h4>source.pkr.hcl</h4>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource packer number-lines code-with-copy"><code class="sourceCode packer"><span id="cb4-1"><a></a><span class="kw">source</span> <span class="st">"amazon-instance"</span> <span class="st">"basic-example"</span> {</span>
<span id="cb4-2"><a></a>  region        <span class="op">=</span> <span class="st">"eu-west-2"</span></span>
<span id="cb4-3"><a></a>  source_ami    <span class="op">=</span> <span class="st">"ami-d9d6a6b0"</span></span>
<span id="cb4-4"><a></a>  instance_type <span class="op">=</span> <span class="st">"m1.small"</span></span>
<span id="cb4-5"><a></a>  ssh_username  <span class="op">=</span> <span class="st">"ubuntu"</span></span>
<span id="cb4-6"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Top-level source block defines reusable builder configuration blocks</li>
</ul>
</section>
<section class="slide level2">
<h2>Blocks</h2>
<h3>build.pkr.hcl</h3>
<div class="sourceCode" id="cb5" data-code-line-numbers="|8-15|17-21|23-26|28-31"><pre class="sourceCode numberSource packer number-lines code-with-copy"><code class="sourceCode packer"><span id="cb5-1"><a></a><span class="kw">build</span> {</span>
<span id="cb5-2"><a></a>  <span class="co"># use the `name` field to name a build in the logs.</span></span>
<span id="cb5-3"><a></a>  <span class="co"># For example this present config will display</span></span>
<span id="cb5-4"><a></a>  <span class="co"># "buildname.amazon-ebs.example-1" and</span></span>
<span id="cb5-5"><a></a>  <span class="co"># "buildname.amazon-ebs.example-2"</span></span>
<span id="cb5-6"><a></a>  name <span class="op">=</span> <span class="st">"buildname"</span></span>
<span id="cb5-7"><a></a></span>
<span id="cb5-8"><a></a>  <span class="kw">source</span> <span class="st">"source.amazon-ebs.example-1"</span> {</span>
<span id="cb5-9"><a></a>    <span class="co"># Use the singular `source` block set specific fields.</span></span>
<span id="cb5-10"><a></a>    <span class="co"># Note that fields cannot be overwritten, in other words,</span></span>
<span id="cb5-11"><a></a>    <span class="co"># you cannot set the 'output' field from the top-level</span></span>
<span id="cb5-12"><a></a>    <span class="co"># source block and here.</span></span>
<span id="cb5-13"><a></a>    output <span class="op">=</span> <span class="st">"different value"</span></span>
<span id="cb5-14"><a></a>    name   <span class="op">=</span> <span class="st">"differentname"</span></span>
<span id="cb5-15"><a></a>  }</span>
<span id="cb5-16"><a></a></span>
<span id="cb5-17"><a></a>  <span class="kw">sources</span> <span class="op">=</span> [</span>
<span id="cb5-18"><a></a>    <span class="co"># use the optional plural `sources` list to simply use a `source`</span></span>
<span id="cb5-19"><a></a>    <span class="co"># without changing any field.</span></span>
<span id="cb5-20"><a></a>    <span class="st">"source.amazon-ebs.example-2"</span>,</span>
<span id="cb5-21"><a></a>  ]</span>
<span id="cb5-22"><a></a></span>
<span id="cb5-23"><a></a>  <span class="co"># runs on the remote machine</span></span>
<span id="cb5-24"><a></a>  <span class="kw">provisioner</span> <span class="st">"shell"</span> {</span>
<span id="cb5-25"><a></a>    scripts <span class="op">=</span> <span class="bu">fileset</span>(<span class="st">"."</span>, <span class="st">"scripts/{install,secure}.sh"</span>)</span>
<span id="cb5-26"><a></a>  }</span>
<span id="cb5-27"><a></a></span>
<span id="cb5-28"><a></a>  <span class="co"># runs on the machine where Packer is running</span></span>
<span id="cb5-29"><a></a>  post<span class="op">-</span>processor <span class="st">"shell-local"</span> {</span>
<span id="cb5-30"><a></a>    inline <span class="op">=</span> [<span class="st">"echo Hello World from </span><span class="ss">${</span><span class="va">source.type</span><span class="ss">}</span><span class="st">.</span><span class="ss">${</span><span class="va">source.name</span><span class="ss">}</span><span class="st">"</span>]</span>
<span id="cb5-31"><a></a>  }</span>
<span id="cb5-32"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">
<h2>RHEL image</h2>
<h4>source</h4>
<div class="sourceCode" id="cb6" data-code-line-numbers="|3-7|20-26|28|43-44"><pre class="sourceCode numberSource packer number-lines code-with-copy"><code class="sourceCode packer"><span id="cb6-1"><a></a><span class="kw">source</span> <span class="st">"qemu"</span> <span class="st">"rhel"</span> {</span>
<span id="cb6-2"><a></a>  accelerator       <span class="op">=</span> <span class="st">"kvm"</span></span>
<span id="cb6-3"><a></a>  boot_command      <span class="op">=</span> [</span>
<span id="cb6-4"><a></a>    <span class="st">"&lt;up&gt;&lt;wait&gt;&lt;wait&gt;e&lt;down&gt;&lt;down&gt;&lt;end&gt;&lt;bs&gt;&lt;bs&gt;&lt;bs&gt;&lt;bs&gt;&lt;bs&gt;"</span>,</span>
<span id="cb6-5"><a></a>    <span class="st">"inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ks.cfg"</span>,</span>
<span id="cb6-6"><a></a>    <span class="st">"&lt;leftCtrlOn&gt;x&lt;leftCtrlOff&gt;"</span></span>
<span id="cb6-7"><a></a>  ]</span>
<span id="cb6-8"><a></a>  boot_wait         <span class="op">=</span> <span class="st">"20s"</span></span>
<span id="cb6-9"><a></a>  communicator      <span class="op">=</span> <span class="st">"ssh"</span></span>
<span id="cb6-10"><a></a>  disk_cache        <span class="op">=</span> <span class="st">"none"</span></span>
<span id="cb6-11"><a></a>  disk_compression  <span class="op">=</span> <span class="va">true</span></span>
<span id="cb6-12"><a></a>  disk_discard      <span class="op">=</span> <span class="st">"unmap"</span></span>
<span id="cb6-13"><a></a>  disk_interface    <span class="op">=</span> <span class="st">"virtio"</span></span>
<span id="cb6-14"><a></a>  disk_size         <span class="op">=</span> <span class="st">"40Gi"</span></span>
<span id="cb6-15"><a></a>  efi_boot          <span class="op">=</span> <span class="va">true</span></span>
<span id="cb6-16"><a></a>  efi_firmware_code <span class="op">=</span> <span class="st">"/usr/share/edk2/ovmf/OVMF_CODE.fd"</span></span>
<span id="cb6-17"><a></a>  efi_firmware_vars <span class="op">=</span> <span class="st">"/usr/share/edk2/ovmf/OVMF_VARS.fd"</span></span>
<span id="cb6-18"><a></a>  format            <span class="op">=</span> <span class="st">"qcow2"</span></span>
<span id="cb6-19"><a></a>  headless          <span class="op">=</span> <span class="va">true</span></span>
<span id="cb6-20"><a></a>  http_content <span class="op">=</span> {</span>
<span id="cb6-21"><a></a>    <span class="st">"/ks.cfg"</span> <span class="op">=</span> <span class="bu">templatefile</span>(<span class="st">"http/rhel9-ks.cfg.pkrtpl"</span>, {</span>
<span id="cb6-22"><a></a>      root_password       <span class="op">=</span> <span class="va">var</span>.root_password</span>
<span id="cb6-23"><a></a>      root_ssh_public_key <span class="op">=</span> <span class="kw">data</span>.sshkey.install.public_key</span>
<span id="cb6-24"><a></a>      os_user             <span class="op">=</span> <span class="va">var</span>.os_user</span>
<span id="cb6-25"><a></a>    })</span>
<span id="cb6-26"><a></a>  }</span>
<span id="cb6-27"><a></a>  iso_checksum     <span class="op">=</span> <span class="st">"rhel-9.4-x86_64-dvd.checksum"</span></span>
<span id="cb6-28"><a></a>  iso_url          <span class="op">=</span> <span class="st">"rhel-9.4-x86_64-dvd.iso"</span></span>
<span id="cb6-29"><a></a>  memory           <span class="op">=</span> <span class="st">"8Gi"</span></span>
<span id="cb6-30"><a></a>  machine_type     <span class="op">=</span> <span class="st">"q35"</span></span>
<span id="cb6-31"><a></a>  net_device       <span class="op">=</span> <span class="st">"virtio-net"</span></span>
<span id="cb6-32"><a></a>  output_directory <span class="op">=</span> <span class="st">"./build"</span></span>
<span id="cb6-33"><a></a>  qemu_binary      <span class="op">=</span> <span class="st">"/usr/libexec/qemu-kvm"</span></span>
<span id="cb6-34"><a></a>  qemuargs <span class="op">=</span> [</span>
<span id="cb6-35"><a></a>    [<span class="st">"-cpu"</span>, <span class="st">"host,+nx"</span>],</span>
<span id="cb6-36"><a></a>    [<span class="st">"-m"</span>, <span class="st">"</span><span class="ss">${</span><span class="va">var.ram</span><span class="ss">}</span><span class="st">M"</span>],</span>
<span id="cb6-37"><a></a>    [<span class="st">"-smp"</span>, <span class="st">"</span><span class="ss">${</span><span class="va">var.cpu</span><span class="ss">}</span><span class="st">"</span>]</span>
<span id="cb6-38"><a></a>  ]</span>
<span id="cb6-39"><a></a>  shutdown_command        <span class="op">=</span> <span class="st">"sudo /usr/sbin/shutdown -hP now"</span></span>
<span id="cb6-40"><a></a>  ssh_username            <span class="op">=</span> <span class="st">"root"</span></span>
<span id="cb6-41"><a></a>  ssh_read_write_timeout  <span class="op">=</span> <span class="st">"5m"</span></span>
<span id="cb6-42"><a></a>  ssh_timeout             <span class="op">=</span> <span class="st">"25m"</span></span>
<span id="cb6-43"><a></a>  ssh_private_key_file    <span class="op">=</span> <span class="kw">data</span>.sshkey.install.private_key_path</span>
<span id="cb6-44"><a></a>  temporary_key_pair_name <span class="op">=</span> <span class="va">var</span>.temporary_key_pair_name</span>
<span id="cb6-45"><a></a>  vm_name                 <span class="op">=</span> <span class="st">"rhel-9.4-base.qcow2"</span></span>
<span id="cb6-46"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<aside class="notes">
<ul>
<li>Boot command is typed character for charater over a VNC connection</li>
<li>We run an unattended installation using kickstart with the config being supplied by an HTTP server</li>
<li>The kickstart config is templated so we can pass in variables</li>
<li>SSH keys for Ansible to use later (removed at the end of the build)</li>
</ul>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section class="slide level2">
<h2>RHEL image</h2>
<h4>build</h4>
<div class="sourceCode" id="cb7" data-code-line-numbers="|4-6|8-21|51-65|101-112"><pre class="sourceCode numberSource packer number-lines code-with-copy"><code class="sourceCode packer"><span id="cb7-1"><a></a><span class="kw">build</span> {</span>
<span id="cb7-2"><a></a>  name <span class="op">=</span> <span class="st">"harvester"</span></span>
<span id="cb7-3"><a></a></span>
<span id="cb7-4"><a></a>  <span class="kw">sources</span> <span class="op">=</span> [</span>
<span id="cb7-5"><a></a>    <span class="st">"source.qemu.rhel"</span></span>
<span id="cb7-6"><a></a>  ]</span>
<span id="cb7-7"><a></a></span>
<span id="cb7-8"><a></a>  <span class="co"># Run Ansible playbook to do CIS hardening</span></span>
<span id="cb7-9"><a></a>  <span class="kw">provisioner</span> <span class="st">"ansible"</span> {</span>
<span id="cb7-10"><a></a>    extra_arguments <span class="op">=</span> [</span>
<span id="cb7-11"><a></a>      <span class="st">"--extra-vars"</span>,</span>
<span id="cb7-12"><a></a>      <span class="st">"ansible_user=root"</span>,</span>
<span id="cb7-13"><a></a>      <span class="st">"--tags=rhel"</span>,</span>
<span id="cb7-14"><a></a>      <span class="st">"--scp-extra-args"</span>, <span class="st">"'-O'"</span>,</span>
<span id="cb7-15"><a></a>    ]</span>
<span id="cb7-16"><a></a>    galaxy_file          <span class="op">=</span> <span class="st">"</span><span class="ss">${</span><span class="va">path.root</span><span class="ss">}</span><span class="st">/../provisioners/ansible/requirements.yml"</span></span>
<span id="cb7-17"><a></a>    galaxy_force_install <span class="op">=</span> <span class="va">true</span></span>
<span id="cb7-18"><a></a>    playbook_file        <span class="op">=</span> <span class="st">"</span><span class="ss">${</span><span class="va">path.root</span><span class="ss">}</span><span class="st">/../provisioners/ansible/playbooks/cis_hardening.yml"</span></span>
<span id="cb7-19"><a></a>    sftp_command         <span class="op">=</span> <span class="st">"/usr/libexec/openssh/sftp-server -e"</span></span>
<span id="cb7-20"><a></a>    user                 <span class="op">=</span> <span class="st">"root"</span></span>
<span id="cb7-21"><a></a>  }</span>
<span id="cb7-22"><a></a></span>
<span id="cb7-23"><a></a>  <span class="co"># Remove root ssh keys and .ansible directory</span></span>
<span id="cb7-24"><a></a>  <span class="kw">provisioner</span> <span class="st">"shell"</span> {</span>
<span id="cb7-25"><a></a>    inline <span class="op">=</span> [</span>
<span id="cb7-26"><a></a>      <span class="st">"rm -f /etc/ssh/*key*."</span>,</span>
<span id="cb7-27"><a></a>      <span class="st">"rm -rf /root/.ssh"</span>,</span>
<span id="cb7-28"><a></a>      <span class="st">"rm -rf /root/.ansible"</span>,</span>
<span id="cb7-29"><a></a>    ]</span>
<span id="cb7-30"><a></a>    remote_folder <span class="op">=</span> <span class="st">"/opt"</span></span>
<span id="cb7-31"><a></a>  }</span>
<span id="cb7-32"><a></a></span>
<span id="cb7-33"><a></a>  <span class="co"># Generate the checksum files</span></span>
<span id="cb7-34"><a></a>  post<span class="op">-</span>processor <span class="st">"checksum"</span> {</span>
<span id="cb7-35"><a></a>    checksum_types <span class="op">=</span> [<span class="st">"sha256"</span>]</span>
<span id="cb7-36"><a></a>    output         <span class="op">=</span> <span class="st">"</span><span class="ss">${</span><span class="va">var.build_dir</span><span class="ss">}</span><span class="st">/</span><span class="ss">${</span><span class="va">local.qcow2_checksum_file</span><span class="ss">}</span><span class="st">"</span></span>
<span id="cb7-37"><a></a>  }</span>
<span id="cb7-38"><a></a></span>
<span id="cb7-39"><a></a>  <span class="co"># Convert to raw and compress</span></span>
<span id="cb7-40"><a></a>  post<span class="op">-</span>processor <span class="st">"shell-local"</span> {</span>
<span id="cb7-41"><a></a>    inline <span class="op">=</span> [</span>
<span id="cb7-42"><a></a>      <span class="bu">join</span>(<span class="st">" "</span>, [</span>
<span id="cb7-43"><a></a>        <span class="st">"/usr/bin/qemu-img convert"</span>,</span>
<span id="cb7-44"><a></a>        <span class="st">"</span><span class="ss">${</span><span class="va">var.build_dir</span><span class="ss">}</span><span class="st">/</span><span class="ss">${</span><span class="va">local.qcow2_filename</span><span class="ss">}</span><span class="st">"</span>,</span>
<span id="cb7-45"><a></a>        <span class="st">"-O raw </span><span class="ss">${</span><span class="va">var.build_dir</span><span class="ss">}</span><span class="st">/</span><span class="ss">${</span><span class="va">local.raw_filename</span><span class="ss">}</span><span class="st">"</span></span>
<span id="cb7-46"><a></a>      ]),</span>
<span id="cb7-47"><a></a>      <span class="st">"gzip </span><span class="ss">${</span><span class="va">var.build_dir</span><span class="ss">}</span><span class="st">/</span><span class="ss">${</span><span class="va">local.raw_filename</span><span class="ss">}</span><span class="st">"</span></span>
<span id="cb7-48"><a></a>    ]</span>
<span id="cb7-49"><a></a>  }</span>
<span id="cb7-50"><a></a></span>
<span id="cb7-51"><a></a>  <span class="co"># Upload the qcow2 file to Pulp</span></span>
<span id="cb7-52"><a></a>  post<span class="op">-</span>processor <span class="st">"shell-local"</span> {</span>
<span id="cb7-53"><a></a>    inline <span class="op">=</span> [</span>
<span id="cb7-54"><a></a>      <span class="bu">join</span>(<span class="st">" "</span>, [</span>
<span id="cb7-55"><a></a>        <span class="st">"ansible-playbook"</span>,</span>
<span id="cb7-56"><a></a>        <span class="st">"</span><span class="ss">${</span><span class="va">path.root</span><span class="ss">}</span><span class="st">/../provisioners/ansible/playbooks/pulp_upload.yml"</span>,</span>
<span id="cb7-57"><a></a>        <span class="st">"--extra-vars pulp_admin_password='</span><span class="ss">${</span><span class="va">var.pulp_admin_password</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-58"><a></a>        <span class="st">"--extra-vars pulp_artifact_base_path_prefix='</span><span class="ss">${</span><span class="va">var.pulp_content_path_prefix</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-59"><a></a>        <span class="st">"--extra-vars pulp_artifact_path='</span><span class="ss">${</span><span class="va">abspath(var.build_dir)</span><span class="ss">}</span><span class="st">/</span><span class="ss">${</span><span class="va">local.qcow2_filename</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-60"><a></a>        <span class="st">"--extra-vars pulp_artifact_repository='</span><span class="ss">${</span><span class="va">var.pulp_repository_name</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-61"><a></a>        <span class="st">"--extra-vars pulp_url='</span><span class="ss">${</span><span class="va">var.pulp_server_url</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-62"><a></a>        <span class="st">"--tags upload"</span>,</span>
<span id="cb7-63"><a></a>      ])</span>
<span id="cb7-64"><a></a>    ]</span>
<span id="cb7-65"><a></a>  }</span>
<span id="cb7-66"><a></a></span>
<span id="cb7-67"><a></a>  <span class="co"># Upload the compressed raw file to Pulp</span></span>
<span id="cb7-68"><a></a>  post<span class="op">-</span>processor <span class="st">"shell-local"</span> {</span>
<span id="cb7-69"><a></a>    inline <span class="op">=</span> [</span>
<span id="cb7-70"><a></a>      <span class="bu">join</span>(<span class="st">" "</span>, [</span>
<span id="cb7-71"><a></a>        <span class="st">"ansible-playbook"</span>,</span>
<span id="cb7-72"><a></a>        <span class="st">"</span><span class="ss">${</span><span class="va">path.root</span><span class="ss">}</span><span class="st">/../provisioners/ansible/playbooks/pulp_upload.yml"</span>,</span>
<span id="cb7-73"><a></a>        <span class="st">"--extra-vars pulp_admin_password='</span><span class="ss">${</span><span class="va">var.pulp_admin_password</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-74"><a></a>        <span class="st">"--extra-vars pulp_artifact_base_path_prefix='</span><span class="ss">${</span><span class="va">var.pulp_content_path_prefix</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-75"><a></a>        <span class="st">"--extra-vars pulp_artifact_path='</span><span class="ss">${</span><span class="va">abspath(var.build_dir)</span><span class="ss">}</span><span class="st">/</span><span class="ss">${</span><span class="va">local.raw_filename</span><span class="ss">}</span><span class="st">.gz'"</span>,</span>
<span id="cb7-76"><a></a>        <span class="st">"--extra-vars pulp_artifact_repository='</span><span class="ss">${</span><span class="va">var.pulp_repository_name</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-77"><a></a>        <span class="st">"--extra-vars pulp_url='</span><span class="ss">${</span><span class="va">var.pulp_server_url</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-78"><a></a>        <span class="st">"--tags upload"</span>,</span>
<span id="cb7-79"><a></a>      ])</span>
<span id="cb7-80"><a></a>    ]</span>
<span id="cb7-81"><a></a>  }</span>
<span id="cb7-82"><a></a></span>
<span id="cb7-83"><a></a>  <span class="co"># Archive and upload the Audit report</span></span>
<span id="cb7-84"><a></a>  post<span class="op">-</span>processor <span class="st">"shell-local"</span> {</span>
<span id="cb7-85"><a></a>    inline <span class="op">=</span> [</span>
<span id="cb7-86"><a></a>      <span class="st">"zip --junk-paths </span><span class="ss">${</span><span class="va">source.name</span><span class="ss">}</span><span class="st">_</span><span class="ss">${</span><span class="va">var.image_build</span><span class="ss">}</span><span class="st">_cis_report </span><span class="ss">${</span><span class="va">path.root</span><span class="ss">}</span><span class="st">/../provisioners/ansible/playbooks/reports/*.json"</span>,</span>
<span id="cb7-87"><a></a>      <span class="bu">join</span>(<span class="st">" "</span>, [</span>
<span id="cb7-88"><a></a>        <span class="st">"ansible-playbook"</span>,</span>
<span id="cb7-89"><a></a>        <span class="st">"</span><span class="ss">${</span><span class="va">path.root</span><span class="ss">}</span><span class="st">/../provisioners/ansible/playbooks/pulp_upload.yml"</span>,</span>
<span id="cb7-90"><a></a>        <span class="st">"--extra-vars pulp_admin_password='</span><span class="ss">${</span><span class="va">var.pulp_admin_password</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-91"><a></a>        <span class="st">"--extra-vars pulp_artifact_base_path_prefix='</span><span class="ss">${</span><span class="va">var.pulp_content_path_prefix</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-92"><a></a>        <span class="st">"--extra-vars pulp_artifact_path='</span><span class="ss">${</span><span class="va">abspath(path.root)</span><span class="ss">}</span><span class="st">/</span><span class="ss">${</span><span class="va">source.name</span><span class="ss">}</span><span class="st">_</span><span class="ss">${</span><span class="va">var.image_build</span><span class="ss">}</span><span class="st">_cis_report.zip'"</span>,</span>
<span id="cb7-93"><a></a>        <span class="st">"--extra-vars pulp_artifact_repository='</span><span class="ss">${</span><span class="va">var.pulp_repository_name</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-94"><a></a>        <span class="st">"--extra-vars pulp_url='</span><span class="ss">${</span><span class="va">var.pulp_server_url</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-95"><a></a>        <span class="st">"--tags upload"</span>,</span>
<span id="cb7-96"><a></a>      ]),</span>
<span id="cb7-97"><a></a>      <span class="st">"rm -rf </span><span class="ss">${</span><span class="va">path.root</span><span class="ss">}</span><span class="st">/../provisioners/ansible/playbooks/reports"</span>,</span>
<span id="cb7-98"><a></a>    ]</span>
<span id="cb7-99"><a></a>  }</span>
<span id="cb7-100"><a></a></span>
<span id="cb7-101"><a></a>  <span class="co"># Run the terraform tests</span></span>
<span id="cb7-102"><a></a>  post<span class="op">-</span>processor <span class="st">"shell-local"</span> {</span>
<span id="cb7-103"><a></a>    inline <span class="op">=</span> [</span>
<span id="cb7-104"><a></a>      <span class="bu">join</span>(<span class="st">" "</span>, [</span>
<span id="cb7-105"><a></a>        <span class="st">"terraform -chdir=../terraform/modules/harvester-image test"</span>,</span>
<span id="cb7-106"><a></a>        <span class="st">"-var image_description='Test </span><span class="ss">${</span><span class="va">source.name</span><span class="ss">}</span><span class="st"> image'"</span>,</span>
<span id="cb7-107"><a></a>        <span class="st">"-var image_displayname='</span><span class="ss">${</span><span class="va">local.image_name[source.name]</span><span class="ss">}</span><span class="st">-test.qcow2'"</span>,</span>
<span id="cb7-108"><a></a>        <span class="st">"-var image_url='</span><span class="ss">${</span><span class="va">local.latest_image_url[source.name]</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-109"><a></a>        <span class="st">"-var vm_user='</span><span class="ss">${</span><span class="va">var.os_user[source.name]</span><span class="ss">}</span><span class="st">'"</span>,</span>
<span id="cb7-110"><a></a>      ])</span>
<span id="cb7-111"><a></a>    ]</span>
<span id="cb7-112"><a></a>  }</span>
<span id="cb7-113"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">
<h2>File builder to avoid repetition</h2>
<div class="sourceCode" id="cb8" data-code-line-numbers="|1-8|10-15"><pre class="sourceCode numberSource packer number-lines code-with-copy"><code class="sourceCode packer"><span id="cb8-1"><a></a><span class="kw">source</span> <span class="st">"file"</span> <span class="st">"qemu-source"</span> {</span>
<span id="cb8-2"><a></a>  <span class="kw">content</span> <span class="op">=</span>  <span class="bu">templatefile</span>(<span class="st">"./source.pkr.packer.pkrtpl"</span>, {</span>
<span id="cb8-3"><a></a>    build_source                       <span class="op">=</span> <span class="va">var</span>.build_source</span>
<span id="cb8-4"><a></a>    unattended_install_config          <span class="op">=</span> <span class="va">var</span>.unattended_install_config</span>
<span id="cb8-5"><a></a>    unattended_install_config_template <span class="op">=</span> <span class="va">var</span>.unattended_install_config_template</span>
<span id="cb8-6"><a></a>  })</span>
<span id="cb8-7"><a></a>  target <span class="op">=</span>  <span class="st">"</span><span class="ss">${</span><span class="va">var.build_path</span><span class="ss">}</span><span class="st">/source.pkr.packer"</span></span>
<span id="cb8-8"><a></a>}</span>
<span id="cb8-9"><a></a></span>
<span id="cb8-10"><a></a><span class="kw">source</span> <span class="st">"file"</span> <span class="st">"harvester-build"</span> {</span>
<span id="cb8-11"><a></a>  <span class="kw">content</span> <span class="op">=</span>  <span class="bu">templatefile</span>(<span class="st">"./harvester.pkr.packer.pkrtpl"</span>, {</span>
<span id="cb8-12"><a></a>    build_source <span class="op">=</span> <span class="va">var</span>.build_source</span>
<span id="cb8-13"><a></a>  })</span>
<span id="cb8-14"><a></a>  target <span class="op">=</span>  <span class="st">"</span><span class="ss">${</span><span class="va">var.build_path</span><span class="ss">}</span><span class="st">/harvester.pkr.packer"</span></span>
<span id="cb8-15"><a></a>}</span>
<span id="cb8-16"><a></a></span>
<span id="cb8-17"><a></a><span class="kw">build</span> {</span>
<span id="cb8-18"><a></a>  <span class="kw">sources</span> <span class="op">=</span> [</span>
<span id="cb8-19"><a></a>    <span class="st">"source.file.qemu-source"</span>,</span>
<span id="cb8-20"><a></a>    <span class="st">"source.file.harvester-build"</span>,</span>
<span id="cb8-21"><a></a>  ]</span>
<span id="cb8-22"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">
<h2>Multiple OS Builds</h2>

<img data-src="./assets/os-build-tree.png" class="r-stretch quarto-figure-center"><p class="caption">OS build tree</p></section>
<section class="slide level2">
<h2>CI/CD Build</h2>
<div class="sourceCode" id="cb9" data-code-line-numbers="|3-4|27-29|52-60|70-82"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb9-1"><a></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and test base images</span></span>
<span id="cb9-2"><a></a></span>
<span id="cb9-3"><a></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb9-4"><a></a><span class="at">  </span><span class="fu">workflow_call</span><span class="kw">:</span></span>
<span id="cb9-5"><a></a><span class="at">    </span><span class="fu">inputs</span><span class="kw">:</span></span>
<span id="cb9-6"><a></a><span class="at">      </span><span class="fu">build_source</span><span class="kw">:</span></span>
<span id="cb9-7"><a></a><span class="at">        </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb9-8"><a></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb9-9"><a></a><span class="at">      </span><span class="fu">unattended_install_config</span><span class="kw">:</span></span>
<span id="cb9-10"><a></a><span class="at">        </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb9-11"><a></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb9-12"><a></a><span class="at">      </span><span class="fu">unattended_install_config_template</span><span class="kw">:</span></span>
<span id="cb9-13"><a></a><span class="at">        </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb9-14"><a></a><span class="at">        </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb9-15"><a></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb9-16"><a></a><span class="at">      </span><span class="fu">ENG_KUBECONFIG_DATA</span><span class="kw">:</span></span>
<span id="cb9-17"><a></a><span class="at">        </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb9-18"><a></a><span class="at">      </span><span class="fu">ARTIFACTORY_TOKEN</span><span class="kw">:</span></span>
<span id="cb9-19"><a></a><span class="at">        </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb9-20"><a></a><span class="at">      </span><span class="fu">ARTIFACTORY_USER</span><span class="kw">:</span></span>
<span id="cb9-21"><a></a><span class="at">        </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb9-22"><a></a><span class="at">      </span><span class="fu">PULP_ADMIN_PASSWORD</span><span class="kw">:</span></span>
<span id="cb9-23"><a></a><span class="at">        </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb9-24"><a></a></span>
<span id="cb9-25"><a></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb9-26"><a></a><span class="at">  </span><span class="fu">packer</span><span class="kw">:</span></span>
<span id="cb9-27"><a></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span></span>
<span id="cb9-28"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> self-hosted</span></span>
<span id="cb9-29"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> condenser-eng</span></span>
<span id="cb9-30"><a></a><span class="at">    </span><span class="fu">defaults</span><span class="kw">:</span></span>
<span id="cb9-31"><a></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb9-32"><a></a><span class="at">        </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> bash</span></span>
<span id="cb9-33"><a></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb9-34"><a></a><span class="at">      </span><span class="fu">KUBECONFIG</span><span class="kw">:</span><span class="at"> ${{ github.workspace }}/terraform/harvester-image/kubeconfig</span></span>
<span id="cb9-35"><a></a></span>
<span id="cb9-36"><a></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb9-37"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683</span><span class="co"> # v4</span></span>
<span id="cb9-38"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd</span><span class="co"> # v3</span></span>
<span id="cb9-39"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> hashicorp/setup-packer@main</span></span>
<span id="cb9-40"><a></a></span>
<span id="cb9-41"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Write kubeconfig file</span></span>
<span id="cb9-42"><a></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> terraform/harvester-image</span></span>
<span id="cb9-43"><a></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb9-44"><a></a><span class="at">          </span><span class="fu">KUBECONFIG_DATA</span><span class="kw">:</span><span class="at"> ${{ secrets.KUBECONFIG_DATA }}</span></span>
<span id="cb9-45"><a></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb9-46"><a></a>          echo $KUBECONFIG_DATA | base64 --decode &gt; kubeconfig</span>
<span id="cb9-47"><a></a></span>
<span id="cb9-48"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run terraform init</span></span>
<span id="cb9-49"><a></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> terraform/harvester-image</span></span>
<span id="cb9-50"><a></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> terraform init -upgrade</span></span>
<span id="cb9-51"><a></a></span>
<span id="cb9-52"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run packer build for file builder</span></span>
<span id="cb9-53"><a></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> packer/shared</span></span>
<span id="cb9-54"><a></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">&gt;</span></span>
<span id="cb9-55"><a></a>          packer build</span>
<span id="cb9-56"><a></a>          -var build_path="../${{ inputs.build_source }}"</span>
<span id="cb9-57"><a></a>          -var build_source="${{ inputs.build_source }}"</span>
<span id="cb9-58"><a></a>          -var unattended_install_config="${{ inputs.unattended_install_config }}"</span>
<span id="cb9-59"><a></a>          -var unattended_install_config_template="${{ inputs.unattended_install_config_template }}"</span>
<span id="cb9-60"><a></a>          file-builder.pkr.packer</span>
<span id="cb9-61"><a></a></span>
<span id="cb9-62"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run packer init for qemu builder</span></span>
<span id="cb9-63"><a></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> packer/${{ inputs.build_source }}</span></span>
<span id="cb9-64"><a></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> packer init .</span></span>
<span id="cb9-65"><a></a></span>
<span id="cb9-66"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run packer validate for qemu builder</span></span>
<span id="cb9-67"><a></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> packer/${{ inputs.build_source }}</span></span>
<span id="cb9-68"><a></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> packer validate -syntax-only .</span></span>
<span id="cb9-69"><a></a></span>
<span id="cb9-70"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run packer build for qemu builder</span></span>
<span id="cb9-71"><a></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> packer/${{ inputs.build_source }}</span></span>
<span id="cb9-72"><a></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">&gt;</span></span>
<span id="cb9-73"><a></a>          packer build</span>
<span id="cb9-74"><a></a>          -var pulp_admin_password='${{ secrets.PULP_ADMIN_PASSWORD }}'</span>
<span id="cb9-75"><a></a>          -only=harvester.qemu.${{ inputs.build_source }} .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">
<h2>CI/CD Build RHEL</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb10-1"><a></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb10-2"><a></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb10-3"><a></a><span class="at">    </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb10-4"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> .github/workflows/build.yml</span></span>
<span id="cb10-5"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> packer/rhel/**</span></span>
<span id="cb10-6"><a></a></span>
<span id="cb10-7"><a></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb10-8"><a></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb10-9"><a></a><span class="at">    </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> ./.github/workflows/build.yml</span></span>
<span id="cb10-10"><a></a><span class="at">    </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb10-11"><a></a><span class="at">      </span><span class="fu">build_source</span><span class="kw">:</span><span class="at"> rhel</span></span>
<span id="cb10-12"><a></a><span class="at">      </span><span class="fu">unattended_install_config_template</span><span class="kw">:</span><span class="at"> rhel9-ks.cfg.pkrtpl</span></span>
<span id="cb10-13"><a></a><span class="at">      </span><span class="fu">unattended_install_config</span><span class="kw">:</span><span class="at"> ks.cfg</span></span>
<span id="cb10-14"><a></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb10-15"><a></a><span class="at">      </span><span class="fu">KUBECONFIG_DATA</span><span class="kw">:</span><span class="at"> ${{ secrets.ENG_KUBECONFIG_DATA }}</span></span>
<span id="cb10-16"><a></a><span class="at">      </span><span class="fu">PULP_ADMIN_PASSWORD</span><span class="kw">:</span><span class="at"> ${{ secrets.PULP_ADMIN_PASSWORD }}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-pointer/pointer.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'pointer': {"key":"q","color":"red","pointerSize":16,"alwaysVisible":false},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: false,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'fade',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealPointer, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
            const codeEl = trigger.previousElementSibling.cloneNode(true);
            for (const childEl of codeEl.children) {
              if (isCodeAnnotation(childEl)) {
                childEl.remove();
              }
            }
            return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
                // default icon
                link.classList.add("external");
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>